{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.reduceSelectors = undefined;\n\nvar _isUndefined2 = require('lodash/isUndefined');\n\nvar _isUndefined3 = _interopRequireDefault(_isUndefined2);\n\nvar _some2 = require('lodash/some');\n\nvar _some3 = _interopRequireDefault(_some2);\n\nvar _isArray2 = require('lodash/isArray');\n\nvar _isArray3 = _interopRequireDefault(_isArray2);\n\nvar _identity2 = require('lodash/identity');\n\nvar _identity3 = _interopRequireDefault(_identity2);\n\nvar _memoize2 = require('lodash/memoize');\n\nvar _memoize3 = _interopRequireDefault(_memoize2);\n\nvar _mergeWith2 = require('lodash/mergeWith');\n\nvar _mergeWith3 = _interopRequireDefault(_mergeWith2);\n\nvar _clone2 = require('lodash/clone');\n\nvar _clone3 = _interopRequireDefault(_clone2);\n\nvar _set2 = require('lodash/set');\n\nvar _set3 = _interopRequireDefault(_set2);\n\nvar _get2 = require('lodash/get');\n\nvar _get3 = _interopRequireDefault(_get2);\n\nvar _isEmpty2 = require('lodash/isEmpty');\n\nvar _isEmpty3 = _interopRequireDefault(_isEmpty2);\n\nvar _assign2 = require('lodash/assign');\n\nvar _assign3 = _interopRequireDefault(_assign2);\n\nvar _size2 = require('lodash/size');\n\nvar _size3 = _interopRequireDefault(_size2);\n\nvar _take2 = require('lodash/take');\n\nvar _take3 = _interopRequireDefault(_take2);\n\nvar _isFunction2 = require('lodash/isFunction');\n\nvar _isFunction3 = _interopRequireDefault(_isFunction2);\n\nvar _isPlainObject2 = require('lodash/isPlainObject');\n\nvar _isPlainObject3 = _interopRequireDefault(_isPlainObject2);\n\nvar _reduce2 = require('lodash/reduce');\n\nvar _reduce3 = _interopRequireDefault(_reduce2);\n\nvar _extends = Object.assign || function (target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i];\n\n    for (var key in source) {\n      if (Object.prototype.hasOwnProperty.call(source, key)) {\n        target[key] = source[key];\n      }\n    }\n  }\n\n  return target;\n};\n\nexports.getDeepPaths = getDeepPaths;\nexports.omitFunctionPropsDeep = omitFunctionPropsDeep;\nexports.bindReducerToState = bindReducerToState;\nexports.bindReducersToState = bindReducersToState;\nexports.getStatefulPropsContext = getStatefulPropsContext;\nexports.safeMerge = safeMerge;\nexports.buildHybridComponent = buildHybridComponent;\nexports.buildStatefulComponent = buildStatefulComponent;\n\nvar _react = require('react');\n\nvar _react2 = _interopRequireDefault(_react);\n\nvar _logger = require('./logger');\n\nvar _reselect = require('reselect');\n\nvar _createReactClass = require('create-react-class');\n\nvar _createReactClass2 = _interopRequireDefault(_createReactClass);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nfunction getDeepPaths(obj) {\n  var path = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n  return (0, _reduce3.default)(obj, function (terminalKeys, value, key) {\n    return (0, _isPlainObject3.default)(value) ? terminalKeys.concat(getDeepPaths(value, path.concat(key))) : terminalKeys.concat([path.concat(key)]);\n  }, []);\n}\n\nfunction omitFunctionPropsDeep(obj) {\n  return (0, _reduce3.default)(obj, function (memo, value, key) {\n    if ((0, _isPlainObject3.default)(value)) {\n      memo[key] = omitFunctionPropsDeep(value);\n    } else if (!(0, _isFunction3.default)(value)) {\n      memo[key] = value;\n    }\n\n    return memo;\n  }, {});\n}\n\nfunction bindReducerToState(reducerFunction, _ref) {\n  var getState = _ref.getState,\n      setState = _ref.setState;\n  var path = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n  var localPath = (0, _take3.default)(path, (0, _size3.default)(path) - 1);\n  return (0, _assign3.default)(function () {\n    for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    if ((0, _isEmpty3.default)(localPath)) {\n      setState(reducerFunction.apply(undefined, [getState()].concat(args)));\n    } else {\n      var localNextState = reducerFunction.apply(undefined, [(0, _get3.default)(getState(), localPath)].concat(args));\n      setState((0, _set3.default)((0, _clone3.default)(getState()), localPath, localNextState));\n    }\n  }, {\n    path: path\n  });\n}\n\nfunction bindReducersToState(reducers, _ref2) {\n  var getState = _ref2.getState,\n      setState = _ref2.setState;\n  return (0, _reduce3.default)(getDeepPaths(reducers), function (memo, path) {\n    return (0, _set3.default)(memo, path, bindReducerToState((0, _get3.default)(reducers, path), {\n      getState: getState,\n      setState: setState\n    }, path));\n  }, {});\n}\n\nfunction getStatefulPropsContext(reducers, _ref3) {\n  var getState = _ref3.getState,\n      setState = _ref3.setState;\n  var boundReducers = bindReducersToState(reducers, {\n    getState: getState,\n    setState: setState\n  });\n\n  var combineFunctionsCustomizer = function combineFunctionsCustomizer(objValue, srcValue) {\n    if ((0, _isFunction3.default)(srcValue) && (0, _isFunction3.default)(objValue)) {\n      return function () {\n        objValue.apply(undefined, arguments);\n        return srcValue.apply(undefined, arguments);\n      };\n    }\n\n    return safeMerge(objValue, srcValue);\n  };\n\n  var bindFunctionOverwritesCustomizer = function bindFunctionOverwritesCustomizer(objValue, srcValue) {\n    if ((0, _isFunction3.default)(srcValue) && (0, _isFunction3.default)(objValue)) {\n      return bindReducerToState(srcValue, {\n        getState: getState,\n        setState: setState\n      }, objValue.path);\n    }\n\n    return safeMerge(objValue, srcValue);\n  };\n\n  return {\n    getPropReplaceReducers: function getPropReplaceReducers(props) {\n      return (0, _mergeWith3.default)({}, boundReducers, getState(), props, bindFunctionOverwritesCustomizer);\n    },\n    getProps: function getProps(props) {\n      return (0, _mergeWith3.default)({}, boundReducers, getState(), props, combineFunctionsCustomizer);\n    }\n  };\n}\n/**\n * reduceSelectors\n *\n * Generates a root selector from a tree of selectors\n * @param {Object} selectors - a tree of selectors\n * @returns {function} root selector that when called with state, calls each of\n * the selectors in the tree with the state local to that selector.\n *\n * This function is memoized because it's recursive, and we want it to reuse\n * the functions created in the recursive reduce because those functions are\n * also memoized (reselect selectors are memoized with a cache of 1) and we want\n * to maintain their caches.\n */\n\n\nvar reduceSelectors = exports.reduceSelectors = (0, _memoize3.default)(function (selectors) {\n  if (!(0, _isPlainObject3.default)(selectors) && !(0, _get3.default)(selectors, '__esModule', false)) {\n    throw new Error('Selectors must be a plain object with function or plain object values');\n  }\n  /**\n   * For each iteration of `reduceSelectors`, we return a memoized selector so\n   * that individual branches maintain reference equality if they haven't been\n   * modified, even if a sibling (and therefore the parent) has been modified.\n   */\n\n\n  return (0, _reselect.createSelector)(_identity3.default, function (state) {\n    return (0, _reduce3.default)(selectors, function (acc, selector, key) {\n      return _extends({}, acc, _defineProperty({}, key, (0, _isFunction3.default)(selector) ? selector(state) : reduceSelectors(selector)(state[key])));\n    }, state);\n  });\n});\n\nfunction safeMerge(objValue, srcValue) {\n  // don't merge arrays\n  if ((0, _isArray3.default)(srcValue) && (0, _isArray3.default)(objValue)) {\n    return srcValue;\n  } // guards against traversing react elements which can cause cyclical recursion\n  // If we don't have this clause, lodash (as of 4.7.0) will attempt to\n  // deeply clone the react children, which is really freaking slow.\n\n\n  if ((0, _react.isValidElement)(srcValue) || (0, _isArray3.default)(srcValue) && (0, _some3.default)(srcValue, _react.isValidElement) || (0, _isArray3.default)(srcValue) && (0, _isUndefined3.default)(objValue)) {\n    return srcValue;\n  }\n}\n\nfunction buildHybridComponent(baseComponent) {\n  var _ref4 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n      _ref4$replaceEvents = _ref4.replaceEvents,\n      replaceEvents = _ref4$replaceEvents === undefined ? false : _ref4$replaceEvents,\n      _ref4$reducers = _ref4.reducers,\n      reducers = _ref4$reducers === undefined ? (0, _get3.default)(baseComponent, 'definition.statics.reducers', {}) : _ref4$reducers,\n      _ref4$selectors = _ref4.selectors,\n      selectors = _ref4$selectors === undefined ? (0, _get3.default)(baseComponent, 'definition.statics.selectors', {}) : _ref4$selectors;\n\n  var _isLucidHybridComponent = baseComponent._isLucidHybridComponent,\n      displayName = baseComponent.displayName,\n      propTypes = baseComponent.propTypes,\n      _baseComponent$defini = baseComponent.definition;\n  _baseComponent$defini = _baseComponent$defini === undefined ? {} : _baseComponent$defini;\n  var _baseComponent$defini2 = _baseComponent$defini.statics,\n      statics = _baseComponent$defini2 === undefined ? {} : _baseComponent$defini2,\n      defaultProps = baseComponent.defaultProps;\n\n  if (_isLucidHybridComponent) {\n    _logger.logger.warnOnce(displayName, 'Lucid: you are trying to apply buildHybridComponent to ' + displayName + ', which is already a hybrid component. Lucid exports hybrid components by default. To access the dumb components, use the -Dumb suffix, e.g. \"ComponentDumb\"');\n\n    return baseComponent;\n  }\n\n  var selector = reduceSelectors(selectors);\n  return (0, _createReactClass2.default)({\n    propTypes: propTypes,\n    statics: _extends({\n      _isLucidHybridComponent: true,\n      peekDefaultProps: defaultProps\n    }, statics),\n    displayName: displayName,\n    getInitialState: function getInitialState() {\n      var initialState = this.props.initialState; //initial state overrides\n\n      return (0, _mergeWith3.default)({}, omitFunctionPropsDeep(baseComponent.getDefaultProps()), initialState, safeMerge);\n    },\n    componentWillMount: function componentWillMount() {\n      var _this = this;\n\n      var synchronousState = this.state; //store reference to state, use in place of `this.state` in `getState`\n\n      this.boundContext = getStatefulPropsContext(reducers, {\n        getState: function getState() {\n          return (0, _mergeWith3.default)({}, omitFunctionPropsDeep(synchronousState), omitFunctionPropsDeep(_this.props), safeMerge);\n        },\n        setState: function setState(state) {\n          synchronousState = state; //synchronously update the state reference\n\n          _this.setState(state);\n        }\n      });\n    },\n    render: function render() {\n      if (replaceEvents) {\n        return _react2.default.createElement(baseComponent, selector(this.boundContext.getPropReplaceReducers(this.props)), this.props.children);\n      }\n\n      return _react2.default.createElement(baseComponent, selector(this.boundContext.getProps(this.props)), this.props.children);\n    }\n  });\n}\n\nfunction buildStatefulComponent() {\n  _logger.logger.warnOnce('buildHybridComponent-once', 'Lucid: buildStatefulComponent has been renamed to buildHybridComponent.');\n\n  return buildHybridComponent.apply(undefined, arguments);\n}","map":null,"metadata":{},"sourceType":"script"}